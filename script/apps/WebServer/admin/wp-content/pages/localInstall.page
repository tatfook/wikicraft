<?npl
--[[
Title: download the zip form github
Author: big
Date: 2016/10/9
Desc: 
]]

NPL.load("(gl)script/ide/System/Plugins/PluginManager.lua");

addheader('Access-Control-Allow-Origin', '*'); 

local PluginManager = commonlib.gettable("System.Plugins.PluginManager");
local manager = PluginManager.CreateGetInstance("Paracraft");
--echo(manager:GetLoader():RebuildModuleList())  --> list of installed plugins
--manager:GetLoader():LoadAllPlugins() --> load plugins, see PluginLoader for details

local function InstallFromUrl(url)
	local status  = false;
	local dest    = '';

	manager:GetLoader():InstallFromUrl(
		url, 
		function(bStatus, bDest)
			log({"aaaaaa",bStatus,bDest});

			status = bStatus;
			dest   = bDest;

			resume();
		end
	);

	yield();

	return status,dest;
end

if(is_ajax()) then
	add_action(
		'wp_ajax_downloadQueue',
		function()
			local url		  = request:get('url');
			local projectName = request:get('projectName');
			local packagesId  = tonumber(request:get('packagesId'));

			url				  = url..'/archive/master.zip';
			local status	  = -1;--package是否可以下载，以前是否下载过
			local dest		  = '';
			local isYourTurn  = 0;--是否轮到此包下载

			local downloadQueue = manager:GetLoader():GetDownloadQueue();

			if(downloadQueue['waitCount'] == 0 and downloadQueue['downloadStatus'] == 0) then
				status,dest = InstallFromUrl(url);

				downloadQueue['downloadStatus']     = 1;--设置下载中
				downloadQueue['currentPackagesId']  = packagesId;
				downloadQueue['currentProjectName'] = projectName;

				isYourTurn = 1;

			else
				if( downloadQueue.currentPackagesId ~= packagesId ) then
					local waitPackages = downloadQueue.waitPackages;
					if( #waitPackages == 0 or waitPackages[1]['packagesId'] ~= packagesId or downloadQueue.downloadStatus == 1) then
					local isAdd = true;

					log({"#waitPackages",#waitPackages})
					for i=1,#waitPackages do
						if(downloadQueue['waitPackages'][i]['packagesId'] == packagesId) then
							isAdd = false;
							break;
						end
					end

					if(isAdd) then
						downloadQueue['waitCount'] = downloadQueue['waitCount'] + 1;

						local newDownloadPackage = {
							projectName = projectName,
							packagesId	= packagesId
						}

						waitPackages[#waitPackages + 1] = newDownloadPackage;
						log({"newDownloadPackage",newDownloadPackage});
						log({"downloadQueue",downloadQueue});
						end
					else
						status,dest = InstallFromUrl(url);
						downloadQueue['downloadStatus']     = 1;
						downloadQueue['currentPackagesId']  = packagesId;
						downloadQueue['currentProjectName'] = projectName;
						isYourTurn = 1;
					end
				end
			end

			manager:GetLoader():SetDownloadQueue(downloadQueue);

			if(isYourTurn == 1 and status) then
				manager:GetLoader():StartDownloader(url, dest,
					function(bStatus, bDest)
					end
				);
				log({"DDDDD"});
			end

			local currentDownloadInfo = manager:GetLoader():GetDownloadInfo()

			wp_send_json(
				{
					status				= status,--package是否可以下载，以前是否下载过
					waitCount			= downloadQueue['waitCount'],
					currentPackagesId	= downloadQueue['currentPackagesId'],
					currentProjectName	= downloadQueue['currentProjectName'],
					currentDownloadInfo = currentDownloadInfo,
					isYourTurn			= isYourTurn,
					waitPackages		= downloadQueue['waitPackages']
				}
			);
		end
	)

	add_action(
		'wp_ajax_GetCurrentDownload',
		function()
			wp_send_json(manager:GetLoader():GetDownloadInfo());
		end
	);

	return;
end


wp_enqueue_script("jqueryui", "/wp-includes/js/jquery/jquery-ui.min.js"); 
wp_enqueue_script("bootstrap", "/wp-includes/js/bootstrap/js/bootstrap.min.js");
wp_enqueue_script("angular", "/wp-includes/js/angular/angular.min.js");
wp_enqueue_script("angular-ui", "/wp-includes/js/angular/ui-bootstrap-tpls-1.3.3.min.js");
wp_enqueue_script("localInstallController","/wp-includes/js/plugin/localInstallController.js")
wp_enqueue_style("plugin", "/wp-admin/css/plugin.css");
PAGE_NO_SIDE_BAR = true;
?>
<div class="plugin" ng-app="plugin" ng-controller="localInstallController">
	<!--<h1>
        Do you want to install the following <br/> plugin to your local computer?
	</h1>-->

    <div class="infor-details">
        <div class="item">
            <label>Package name</label>
            <div>{{projectName}}</div>
        </div>
        <div class="item">
            <label>Author</label>
            <div>{{author}}</div>
        </div>
        <div class="item">
            <label>Version</label>
            <div>{{version}}</div>
        </div>
    </div>
    <div class="quene">
        <h4>Thanks for download.</h4>
		<br>
		<h4 style="margin-top: -8px;">[Current Download]</h4>
        <div>
			 <b>{{currentProjectName}}</b>
		</div>
		<br>
		<h4>[Waiting download packages]</h4>
		<div ng-repeat="package in waitPackages track by $index">
			<b>
			   #{{$index+1}} &nbsp;&nbsp;&nbsp;
			   Project name:{{package.projectName}} &nbsp;&nbsp;&nbsp;
			   Package id:{{package.packagesId}}
			</b>
			<b ng-if="waitPackagesIsEmpty">
				Not yet!
			</b>
		</div>
    </div>
    <div class="button">
        <button class="start" ng-click="install()" disabled="disable">After {{seconds}}s will start</button>
        <button class="process" disabled="disabled"></button>
        <span> Press close button at right top corner</span>
        <!--<button ng-click="cancel()">Cancel</button>-->
    </div>
</div>