<?npl
--[[
Title: download the zip form github
Author: big
Date: 2016/10/9
Desc: 
]]

NPL.load("(gl)script/ide/System/Plugins/PluginManager.lua");

addheader('Access-Control-Allow-Origin', '*'); 

local PluginManager = commonlib.gettable("System.Plugins.PluginManager");
local manager = PluginManager.CreateGetInstance("Paracraft");
--echo(manager:GetLoader():RebuildModuleList())  --> list of installed plugins
--manager:GetLoader():LoadAllPlugins() --> load plugins, see PluginLoader for details

function localInstall:InstallFromUrl()
	local judge  = false;
	local dest   = '';

	manager:GetLoader():InstallFromUrl(
		url, 
		function(bStatus, bDest)
			log({bStatus,bDest});

			judge = bStatus;
			dest  = bDest;

			resume();
		end
	);

	yield();
end

if(is_ajax()) then
	add_action(
		'wp_ajax_downloadzip',
		function()
			local url = request:get('url');

			url = url..'/archive/master.zip';

			wp_send_json({status=1,msg="Start Download"});
		end
	);

	add_action(
		'wp_ajax_downloadQueue',
		function()
			local url = request:get('url');
			local projectName = request:get('projectName');

			url = url..'/archive/master.zip';

			local downloadQueue = manager:GetLoader():GetDownloadQueue();

			if(downloadQueue['downloadStatus'] == 1) then
				downloadQueue['waitCount']++

			else
				if(downloadQueue['waitCount'] == 0) then
					localInstall:InstallFromUrl();
					downloadQueue['downloadStatus'] = 1;--设置下载中
				else

				end
			end

			local status = 0;

			if(judge) then

				manager:GetLoader():StartDownloader(url, dest, 
					function(bStatus, bDest)
						
					end
				);

				status = 1;
			else
				status = 0;
			end

			wp_send_json(
				{
					status = status,
					waitCount=0,
					isYourTurn=0,
					waitPackages={
						{
							projectName="AAAA",
							packagesId = 1,
						},
						{
							projectName="BBBB",
							packagesId = 2,
							
						}
					}
				}
			);
		end
	)

	add_action(
		'wp_ajax_setDownloadQueue',
		function()
			local projectName = request.get("projectName");

			queueId = manager:GetLoader():SetDownloadQueue(projectName);

			wp_send_json({queueId=queueId})
		end
	)

	add_action(
		'wp_ajax_GetCurrentDownload',
		function()
			wp_send_json(manager:GetLoader():GetDownloadInfo());
		end
	);

	return;
end


wp_enqueue_script("jqueryui", "/wp-includes/js/jquery/jquery-ui.min.js"); 
wp_enqueue_script("bootstrap", "/wp-includes/js/bootstrap/js/bootstrap.min.js");
wp_enqueue_script("angular", "/wp-includes/js/angular/angular.min.js");
wp_enqueue_script("angular-ui", "/wp-includes/js/angular/ui-bootstrap-tpls-1.3.3.min.js");
wp_enqueue_script("localInstallController","/wp-includes/js/plugin/localInstallController.js")
wp_enqueue_style("plugin", "/wp-admin/css/plugin.css");
PAGE_NO_SIDE_BAR = true;
?>
<div class="plugin" ng-app="plugin" ng-controller="localInstallController">
	<!--<h1>
        Do you want to install the following <br/> plugin to your local computer?
	</h1>-->

    <div class="infor-details">
        <div class="item">
            <label>Package name</label>
            <div>{{projectName}}</div>
        </div>
        <div class="item">
            <label>Author</label>
            <div>{{author}}</div>
        </div>
        <div class="item">
            <label>Version</label>
            <div>{{version}}</div>
        </div>
    </div>
    <div class="quene">
        <div>Thanks for download.</div>
        <!--<div>BBB is waiting</div>
        <div>CCC is waiting</div>
        <div>AAA is complete!</div>
        <div>Starting download BBB</div>
        <div>BBB is downloading 25% 123/999 KB</div>
        <div>BBB is complete!</div>
        <div>Starting download CCC</div>
        <div>CCC is downloading 25% 123/999 KB</div>
        <div>CCC is complete!</div>-->
    </div>
    <div class="button">
        <button class="start" ng-click="install()" disabled="disable">After {{seconds}}s will start</button>
        <button class="process" disabled="disabled"></button>
        <span> Press close button at right top corner</span>
        <!--<button ng-click="cancel()">Cancel</button>-->
    </div>
</div>