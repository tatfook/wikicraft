<?npl
--[[
Title: org member
Author: wuxiangan
Date: 2016/11/07
]]

include_once("./abstract/base.page");
include_once("./website.page");

local org_website = inherit(models.abstract.base, gettable("models.org_website"))
org_website.db_name="org_website"

function org_website:ctor()
	self:addfield("name", "string", true, 30) -- 组织名
	self:addfield("websiteId", "string")      -- 组织内作品的ID

	self:addfield("createDate", "string", false, 64);
	self:addfield("updateDate", "string", false, 64);
end


-- 获取组织成员
function org_website:api_getOrgWebsiteCount(params)
	if not params.websiteName then
		return {error=errors.REQUEST_PARAMS_ERROR, data=nil}
	end

	self:db():count({["+name"]={params.websiteName}}, resume)
	local err, data = yield()
	
	if err then
		return errors:wrap(err, data)
	end

	return {error=errors.SUCCESS, data=data}
end


-- 获取成员列表
function org_website:api_getOrgWebsiteList(params)
	if not params.websiteName then
		return {error=errors.REQUEST_PARAMS_ERROR, data=nil}
	end
	
	local page = params.page or 1
	local pageSize = params.pageSize  or 10
	local skip = (page - 1) * pageSize
	
	self:db():find({["+name"]={params.websiteName,limit=pageSize, skip=skip}}, resume)
	local err, data = yield()

	if err then
		return errors:wrap(err, data)
	end
	
	-- TODO 获取userDB对象
	local websiteDB = models.website:new()
	local siteInfoList = {}
	for _, siteIdObj in ipairs(data) do
		websiteDB:db():findOne([_id=siteIdObj.websiteId], resume)
		err, siteInfo = yield()
		siteInfoList[#siteInfoList+1] = siteInfo	
	end
	
	return {error=errors.SUCCESS, data=siteInfoList}
end

function org_website:create(params) 
	params.createDate = ParaGlobal.GetDateFormat("yyyy-MM-dd")
	params.updateDate = params.createDate

	self:db():insertOne(nil, params, resume)
	local err, data = yield()
	
	if err then
		return errors:wrap(err, data)
	end

	return {error=errors.SUCCESS, data=data}
end
