<?npl
--[[
Title: modelshare
Author: 
Date: 2017/7/19
http://localhost:8099//api/mod/modelshare/models/modelshare  地址
跳转location.href = "/"
]]

include_once("../../../models/abstract/multi_user_base.page");

local modelshare = inherit(models.abstract.multi_user_base, gettable("models.modelshare"));
local modelsn = inherit(models.abstract.multi_user_base, gettable("models.modelsn"));

modelshare.db_name = "modelshare";

modelsn.db_name    = "modelsn";
modelsn            = modelsn:new();

function modelshare:ctor()
	self:addfield("templateName", "string",false);
	self:addfield("username", "string", false);
	self:addfield("modelsnumber","number",false);
	self:addfield("blocks","number",false);
	self:addfield("volume","string",false);
	self:addfield("words","string",false);
	self:addfield("_id","number",false);
	self:addfield("isShare","number",false);
	
end
--增加
function modelshare:api_add(params)
	local err, query = self:validateQuery(params);
	--log(query)
	self:db():insertOne(
		{
			templateName = query.templateName,
			username     = self:getUsername(),
			modelsnumber = modelsn:getSn(),
			blocks       = query.blocks,
			volume       = query.volume,
			isShare      = query.isShare
			
		}, resume);
	local err, data = yield();
	if not err then
		return errors:wrap(nil, data);
	else
		return errors:wrap(errors.SERVER_INNER_ERROR);
	end

end
--查找
function modelshare:api_getOne(params)
	local err, query = self:validateQuery(params);
	--log(params)
	--log(query)
	self:db():findOne({_id = query._id},resume);
	local err, data = yield();
	
	if not err then
		return errors:wrap(nil, data);
	else
		return errors:wrap(errors.SERVER_INNER_ERROR);
	end
end
--修改
function modelshare:api_modify(params)
	local err, query = self:validateQuery(params);
	
	if(not query._id) then
		return errors:wrap(errors.SERVER_INNER_ERROR);
	end
	
	if(not query.foo) then
		return errors:wrap(errors.SERVER_INNER_ERROR);
	end
	
	self:db():updateOne({_id = query._id},
	{
			templateName = query.templateName,
			author       = query.author,
			modelsnumber = query.modelsnumber,
			blocks       = query.block,
			volume       = query.volume,
			words        = query.words,
			
	},resume);
	local err,data = yield();
	
	if not err then
		return errors:wrap(nil, data);
	else
		return errors:wrap(errors.SERVER_INNER_ERROR);
	end

end
--删除
function modelshare:api_delete(params)
	local err, query = self:validateQuery(params);
	
	if(not query.id) then
		return errors:wrap(errors.SERVER_INNER_ERROR);
	end
	
	self:db():deleteOne({_id = query.id}, resume);
	local err,data = yield();
	
	if not err then
		return errors:wrap(nil, data);
	else
		return errors:wrap(errors.SERVER_INNER_ERROR);
	end
	
end
--序列号生成
function modelsn:getSn()
	self:db():insertOne({},resume);
	local err, phoneNumber = yield();
	local sn = "100";
	phoneNumber  = tostring(phoneNumber._id);
	a =8 - #phoneNumber;

	for i=1,a do 
		phoneNumber = "0" .. phoneNumber;
		i=i+1;
	end

	return sn .. phoneNumber
end

?>