<?npl
--[[
Title: editor page
Author: KarlWu
Date: 2016/10/17
]]

wp_enqueue_script("markdownit-emoji", "https://twemoji.maxcdn.com/twemoji.min.js");

wp_enqueue_script("markdownit-show", WIKI_WEBROOT.."controllers/markdownitIndex.js");
wp_enqueue_script("bootstrap-treeview", "/wp-includes/js/bootstrap/js/bootstrap-treeview.js");

wp_enqueue_script("codemirror", "/wp-includes/js/codemirror/lib/codemirror.js");
wp_enqueue_style("codemirror_style", "/wp-includes/js/codemirror/lib/codemirror.css");
wp_enqueue_script("codemirror_mode_markdown", "/wp-includes/js/codemirror/mode/markdown/markdown.js");

wp_enqueue_script("codemirror_addon_dialog", "/wp-includes/js/codemirror/addon/dialog/dialog.js");
wp_enqueue_style("codemirror_addon_dialog_style", "/wp-includes/js/codemirror/addon/dialog/dialog.css");

wp_enqueue_script("codemirror_addon_continuelist", "/wp-includes/js/codemirror/addon/edit/continuelist.js");
wp_enqueue_script("codemirror_addon_searchcursor", "/wp-includes/js/codemirror/addon/search/searchcursor.js");
wp_enqueue_script("codemirror_addon_search", "/wp-includes/js/codemirror/addon/search/search.js");
wp_enqueue_script("codemirror_addon_matchesonscrollbar", "/wp-includes/js/codemirror/addon/search/matchesonscrollbar.js");
wp_enqueue_style("codemirror_addon_matchesonscrollbar_style", "/wp-includes/js/codemirror/addon/search/matchesonscrollbar.css");
wp_enqueue_script("codemirror_addon_jumptoline", "/wp-includes/js/codemirror/addon/search/jump-to-line.js");
wp_enqueue_script("codemirror_addon_annotatescrollbar", "/wp-includes/js/codemirror/addon/scroll/annotatescrollbar.js");
wp_enqueue_script("codemirror_addon_fullscreen", "/wp-includes/js/codemirror/addon/display/fullscreen.js");
wp_enqueue_style("codemirror_addon_fullscreen_style", "/wp-includes/js/codemirror/addon/display/fullscreen.css");

wp_enqueue_script("editorController", WIKI_WEBROOT.."controllers/editorController.js");
wp_enqueue_style("editor_style", WIKI_WEBROOT.."assets/editor.css");

?>

<div ng-controller="editorController">
    <div class="btn-toolbar" role="toolbar">
        <div class="btn-group">
            <button type="button" class="btn btn-default btn-sm"  ng-click="cmd_savepage()">保存</button>
        </div>
        <div class="btn-group">
            <button type="button" class="btn btn-default btn-sm"  ng-click="cmd_undo()">撤销</button>
            <button type="button" class="btn btn-default btn-sm"  ng-click="cmd_redo()">重做</button>
            <!--<br/>-->
            <button type="button" class="btn btn-default btn-sm"  ng-click="cmd_find()">查找</button>
            <button type="button" class="btn btn-default btn-sm"  ng-click="cmd_replace()">替换</button>
        </div>
        <div class="btn-group">
            <button type="button" class="btn btn-default btn-sm"  ng-click="cmd_headline(1)">H1</button>
            <button type="button" class="btn btn-default btn-sm"  ng-click="cmd_headline(2)">H2</button>
            <button type="button" class="btn btn-default btn-sm"  ng-click="cmd_headline(3)">H3</button>
            <button type="button" class="btn btn-default btn-sm"  ng-click="cmd_identifier()">编号</button>
            <button type="button" class="btn btn-default btn-sm">加粗</button>
            <button type="button" class="btn btn-default btn-sm">斜体</button>
            <button type="button" class="btn btn-default btn-sm">下划线</button>
            <button type="button" class="btn btn-default btn-sm">符号</button>
        </div>
        <div class="btn-group">
            <button type="button" class="btn btn-default btn-sm">URL</button>
            <button type="button" class="btn btn-default btn-sm">图片</button>
            <!--<br/>-->
            <button type="button" class="btn btn-default btn-sm">表格</button>
            <button type="button" class="btn btn-default btn-sm">批注</button>
        </div>
        <div class="btn-group pull-right">
            <button type="button" class="btn btn-default btn-sm">版本</button>
            <button type="button" class="btn btn-default btn-sm">热键</button>
            <button type="button" class="btn btn-default btn-sm">知识库</button>
        </div>
    </div>
    <div class="btn-toolbar" role="toolbar">
        <div class="btn-group">
            <button type="button" class="btn btn-default btn-sm">模块1</button>
            <button type="button" class="btn btn-default btn-sm">模块2</button>
            <button type="button" class="btn btn-default btn-sm">模块3</button>
            <button type="button" class="btn btn-default btn-sm">模块4</button>
            <!--<br/>-->
            <button type="button" class="btn btn-default btn-sm">模块5</button>
            <button type="button" class="btn btn-default btn-sm">模块6</button>
            <button type="button" class="btn btn-default btn-sm">模块7</button>
            <button type="button" class="btn btn-default btn-sm">模块8</button>
            <div class="btn-group">
                <button type="button" class="btn btn-default btn-sm dropdown-toggle" data-toggle="dropdown">
                    更多模块
                    <span class="caret"></span>
                </button>
                <ul class="dropdown-menu">
                    <li><a href="#">下拉模块 1</a></li>
                    <li><a href="#">下拉模块 2</a></li>
                    <li><a href="#">下拉模块 3</a></li>
                    <li class="divider"></li>
                    <li><a href="#">下拉模块 4</a></li>
                    <li><a href="#">下拉模块 5</a></li>
                </ul>
            </div>
        </div>
    </div>

    <nav class="navbar" role="navigation">
        <div class="container-fluid">
            <div>
                <ul class="nav navbar-nav nav-pills">
                    <li class="active toolbar-page-file"><a href="#">文件</a></li>
                    <li class="toolbar-page-code"><a href="#">代码</a></li>
                    <li class="active toolbar-page-slide"><a href="#">拆分</a></li>
                    <li class="toolbar-page-design"><a href="#">设计</a></li>
                    <li class="disabled" ><a href="#" id="websiteUrl"></a></li>
                    <li class="toolbar-page-copyurl"><a class="btn btn-default btn-sm navbar-btn" href="#">复制网址</a></li>
                    <li class="toolbar-page-preview"><a class="btn btn-default btn-sm navbar-btn" href="#">预览</a></li>
                </ul>
            </div>
            <div class="navbar-right">
                <!--<button type="button" class="btn btn-default btn-sm navbar-btn toolbar-page-new">-->
                <!--新建页-->
                <!--</button>-->
                <ul class="nav navbar-nav">
                    <li class="toolbar-page-new"><a class="btn btn-default btn-sm navbar-btn" href="#">新建页</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="full-height" style="margin-top: 20px;">
        <div id="treeview" class="col-xs-2 full-height nopadding nomargin"></div>
        <div id="srcview" class="col-xs-5 full-height nopadding nomargin">
            <div class="demo-control"><a href="#" class="source-clear">清除</a></div>
            <textarea id="source" name="source" class="source full-height" TextMode="MultiLine"></textarea>
        </div>
        <section id="preview" class="col-xs-5 full-height nopadding nomargin">
            <div class="demo-control"><a href="#" data-result-as="html">HTML</a>
                <a href="#" data-result-as="src">源代码</a>
                <!--<a href="#" data-result-as="debug">debug</a>-->
            </div>
            <div class="result-html full-height"></div>
            <pre class="hljs result-src full-height"><code class="result-src-content full-height"></code></pre>
            <pre class="hljs result-debug full-height"><code class="result-debug-content full-height"></code></pre>
        </section>
    </div>

</div>

<script>
    /**
     * Created by karlwu on 2016-11-02.
     */
    var editor = CodeMirror.fromTextArea(document.getElementById("source"), {
        mode: 'markdown',
        lineNumbers: true,
        lineWrapping: true,
        theme: "default",
        viewportMargin: Infinity,
        extraKeys: {
            "Enter": "newlineAndIndentContinueMarkdownList",
            "Alt-F": "findPersistent",
            Tab: function(cm) {
                var spaces = Array(cm.getOption("indentUnit") + 1).join(" ");
                cm.replaceSelection(spaces);
            },
            "F11": function(cm) {
                cm.setOption("fullScreen", !cm.getOption("fullScreen"));
            },
            "Esc": function(cm) {
                if (cm.getOption("fullScreen")) cm.setOption("fullScreen", false);
            }
        }
    });

    var showTreeview = true;

    function initView(activity){

        $("#srcview").removeClass('col-xs-12');
        $("#srcview").removeClass('col-xs-10');
        $("#srcview").removeClass('col-xs-6');
        $("#srcview").removeClass('col-xs-5');

        $("#preview").removeClass('col-xs-12');
        $("#preview").removeClass('col-xs-10');
        $("#preview").removeClass('col-xs-6');
        $("#preview").removeClass('col-xs-5');

        if(activity == true){
            $('.toolbar-page-slide').removeClass('active');
            $('.toolbar-page-code').removeClass('active');
            $('.toolbar-page-design').removeClass('active');
        }

        if($("#treeview").is(":hidden")){
            if($("#preview").is(":hidden")){
                $("#srcview").addClass('col-xs-12');
            }else{
                $("#srcview").addClass('col-xs-6');
            }
            if($("#srcview").is(":hidden")){
                $("#preview").addClass('col-xs-12');
            }else{
                $("#preview").addClass('col-xs-6');
            }
        }else{
            if($("#preview").is(":hidden")){
                $("#srcview").addClass('col-xs-10');
            }else{
                $("#srcview").addClass('col-xs-5');
            }
            if($("#srcview").is(":hidden")){
                $("#preview").addClass('col-xs-10');
            }else{
                $("#preview").addClass('col-xs-5');
            }
        }
    }

    $('.toolbar-page-file').on('click',function(){
        $('#treeview').toggle('fast',function(){
            initView(false);
            if($("#treeview").is(":hidden")){
                $('.toolbar-page-file').removeClass('active');
            }else{
                $('.toolbar-page-file').addClass('active');
            }
        });
    });

    $('.toolbar-page-code').on('click',function(){
        $('#srcview').show();
        $("#preview").hide('fast',function(){
            initView(true);
            $('.toolbar-page-code').addClass('active');
        });
    });

    $('.toolbar-page-slide').on('click',function(){
        $('#srcview').show();
        $("#preview").show('fast',function(){
            initView(true);
            $('.toolbar-page-slide').addClass('active');
        });
    });

    $('.toolbar-page-design').on('click',function(){
        $('#preview').show();
        $("#srcview").hide('fast',function(){
            initView(true);
            $('.toolbar-page-design').addClass('active');
        });
    });

    //获取剪贴板数据方法
    function getClipboardText(event){
        var clipboardData = event.clipboardData || window.clipboardData;
        return clipboardData.getData("text");
    };

    //设置剪贴板数据
    function setClipboardText(event, value){
        if(event.clipboardData){
            return event.clipboardData.setData("text/plain", value);
        }else if(window.clipboardData){
            return window.clipboardData.setData("text", value);
        }
    };

    function CreateElementForExecCommand (textToClipboard) {
        var forExecElement = document.createElement ("div");
        // place outside the visible area
        forExecElement.style.position = "absolute";
        forExecElement.style.left = "-10000px";
        forExecElement.style.top = "-10000px";
        // write the necessary text into the element and append to the document
        forExecElement.textContent = textToClipboard;
        document.body.appendChild (forExecElement);
        // the contentEditable mode is necessary for the  execCommand method in Firefox
        forExecElement.contentEditable = true;

        return forExecElement;
    }

    function SelectContent (element) {
        // first create a range
        var rangeToSelect = document.createRange ();
        rangeToSelect.selectNodeContents (element);

        // select the contents
        var selection = window.getSelection ();
        selection.removeAllRanges ();
        selection.addRange (rangeToSelect);
    }

    function CopyToClipboard (value) {
        var textToClipboard = value;

        var success = true;
        if (window.clipboardData) { // Internet Explorer
            window.clipboardData.setData ("Text", textToClipboard);
        }
        else {
            // create a temporary element for the execCommand method
            var forExecElement = CreateElementForExecCommand (textToClipboard);

            /* Select the contents of the element
             (the execCommand for 'copy' method works on the selection) */
            SelectContent (forExecElement);

            var supported = true;

            // UniversalXPConnect privilege is required for clipboard access in Firefox
            try {
                if (window.netscape && netscape.security) {
                    netscape.security.PrivilegeManager.enablePrivilege ("UniversalXPConnect");
                }

                // Copy the selected content to the clipboard
                // Works in Firefox and in Safari before version 5
                success = document.execCommand ("copy", false, null);
            }
            catch (e) {
                success = false;
            }

            // remove the temporary element
            document.body.removeChild (forExecElement);
        }

        if (success) {
            alert ("网址已成功拷贝到剪切板!");
        }
        else {
            alert ("您的浏览器不支持访问剪切板!");
        }
    }

    $('.toolbar-page-copyurl').on('click',function(){
//        console.log(window.location.host);
        CopyToClipboard($('#websiteUrl').html());
    });

    $('.toolbar-page-preview').on('click',function(){
        var url = $('#websiteUrl').html();
        window.open(url);
    });

</script>
